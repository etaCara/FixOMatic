<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ticket Details</title>
  <link rel="stylesheet" href="style.css" />
  <script>
    const username = localStorage.getItem("username");
    if (!username) {
      window.location.href = "index.html";
    }
  </script>
</head>
<body>
  <header class="navbar">
    <h1 class="logo">üõ†Ô∏è Fix-O-Matic</h1>
    <nav>
      <a href="home.html">Home</a>
      <a href="create-ticket.html">Create</a>
      <a href="history.html">History</a>
      <a href="faq.html">FAQ</a>
      <a href="settings.html">Settings</a>
    </nav>
  </header>

  <main class="container">
    <section class="card">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>üéüÔ∏è Ticket Details</h2>
        <button id="editBtn" class="edit-btn">‚úèÔ∏è Edit</button>
      </div>

      <div class="ticket-details" id="ticketDetails">
        <p>Loading ticket data...</p>
      </div>

      <div id="actionButtons" style="display: none; margin-top: 10px;">
        <button id="saveBtn" class="save-btn">üíæ Save Changes</button>
        <button id="cancelBtn" class="cancel-btn">‚ùå Cancel</button>
      </div>

      <a href="in-process.html" class="back-link">‚Üê Back to Tickets</a>
    </section>
  </main>

  <script>
    let ticket = {};
    let editMode = false;

    async function loadTicketDetails() {
      const urlParams = new URLSearchParams(window.location.search);
      const ticketId = urlParams.get("id");
      const container = document.getElementById("ticketDetails");

      if (!ticketId) {
        container.innerHTML = "<p style='color:red;'>No ticket ID provided in the URL.</p>";
        return;
      }

      try {
        const response = await fetch(`https://fixomatic.onrender.com/tickets/${ticketId}`);
        if (!response.ok) throw new Error("Ticket not found");

        ticket = await response.json();
        renderTicketDetails();
      } catch (err) {
        console.error("Error loading ticket:", err);
        container.innerHTML = "<p style='color:red;'>‚ùå Failed to load ticket details. Please try again later.</p>";
      }
    }

    function renderTicketDetails() {
      const container = document.getElementById("ticketDetails");

      if (!editMode) {
        container.innerHTML = `
          <p><strong>ID:</strong> #${ticket.id}</p>
          <p><strong>Title:</strong> ${ticket.title}</p>
          <p><strong>Description:</strong> ${ticket.description}</p>
          <p><strong>Status:</strong> ${ticket.status}</p>
          <p><strong>Severity:</strong> ${ticket.severity || "N/A"}</p>
        `;
      } else {
        container.innerHTML = `
          <p><strong>Title:</strong> <input type="text" id="titleInput" value="${ticket.title}" /></p>
          <p><strong>Description:</strong> <textarea id="descInput">${ticket.description}</textarea></p>
          <p><strong>Status:</strong>
            <select id="statusInput">
              <option value="Open" ${ticket.status === "Open" ? "selected" : ""}>Open</option>
              <option value="In-Process" ${ticket.status === "In-Process" ? "selected" : ""}>In-Process</option>
              <option value="Closed" ${ticket.status === "Closed" ? "selected" : ""}>Closed</option>
            </select>
          </p>
          <p><strong>Severity:</strong> <input type="text" id="severityInput" value="${ticket.severity || ""}" /></p>
        `;
      }
    }

    document.getElementById("editBtn").addEventListener("click", () => {
      editMode = !editMode;
      document.getElementById("actionButtons").style.display = editMode ? "block" : "none";
      document.getElementById("editBtn").textContent = editMode ? "üîí View" : "‚úèÔ∏è Edit";
      renderTicketDetails();
    });

    document.getElementById("cancelBtn").addEventListener("click", () => {
      editMode = false;
      document.getElementById("actionButtons").style.display = "none";
      document.getElementById("editBtn").textContent = "‚úèÔ∏è Edit";
      renderTicketDetails();
    });

    document.getElementById("saveBtn").addEventListener("click", async () => {
      const updatedTicket = {
        ...ticket,
        title: document.getElementById("titleInput").value,
        description: document.getElementById("descInput").value,
        status: document.getElementById("statusInput").value,
        severity: document.getElementById("severityInput").value
      };

      try {
        const response = await fetch(`https://fixomatic.onrender.com/tickets/${ticket.id}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(updatedTicket)
        });

        if (!response.ok) throw new Error("Failed to update ticket");

        ticket = await response.json();
        alert("‚úÖ Ticket updated successfully!");
        editMode = false;
        document.getElementById("actionButtons").style.display = "none";
        document.getElementById("editBtn").textContent = "‚úèÔ∏è Edit";
        renderTicketDetails();
      } catch (err) {
        console.error("Update failed:", err);
        alert("‚ùå Failed to update ticket. Please try again.");
      }
    });

    window.addEventListener("DOMContentLoaded", loadTicketDetails);
  </script>
</body>
</html>
